- name: Install NGINX
  ansible.builtin.include_role:
    name: nginxinc.nginx
  vars:
    nginx_service_modify: true
    nginx_service_timeout: 95
    nginx_logrotate_conf_enable: true
    nginx_logrotate_conf:
      paths:
        - /var/log/nginx/*.log
      options:
        - daily
        - missingok
        - rotate 14
        - compress
        - delaycompress
        - notifempty
        - sharedscriptsgg

- name: Check if NGINX is installed
  ansible.builtin.package:
    name: nginx
    state: present
  check_mode: true
  register: install
  failed_when: (install is changed) or (install is failed)

- name: Check if NGINX service is running
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true
  check_mode: true
  register: service
  failed_when: (service is changed) or (service is failed)

- name: Verify NGINX is up and running
  ansible.builtin.uri:
    url: http://localhost

- name: Copy backend site config
  ansible.builtin.template:
    src: backend.j2
    dest: /etc/nginx/sites-available/backend

- name: Create symlink from backend to default site
  file:
    src: /etc/nginx/sites-available/backend
    dest: /etc/nginx/sites-enabled/default
    state: link

- name: Copy NGINX main config
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    validate: nginx -tc %s
    backup: true

- name: Sanity check that configuration is valid
  ansible.builtin.command: nginx -t

- name: Reload NGINX configuration
  ansible.builtin.command: nginx -sreload
